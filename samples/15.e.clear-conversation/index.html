<!DOCTYPE html>
<html lang="en-US">
  <head>
    <title>Web Chat: Clear chat history</title>
    <!--
      For demonstration purposes, we are using the development branch of Web Chat at "/master/webchat.js".
      When you are using Web Chat for production, you should use the latest stable release at "/latest/webchat.js",
      or lock down on a specific version with the following format: "/4.1.0/webchat.js".
    -->
    <script src="https://cdn.botframework.com/botframework-webchat/master/webchat.js"></script>
    <style>
        html, body { height: 100% }
        body { 
            display: flex;
            flex-direction: column;
            height: 100%;
            margin: 0 
        }

        #webchat {
            flex: 1;
            width: 100%;
        }

        div.time-remaining {
            padding: 10px 10px; 

            color: #807f7f;
            text-align: right;
            font-family: "Calibri", "Helvetica Neue", Arial, sans-serif;
        }
    </style>
  </head>
  <body>
    <div class="time-remaining">
        Time Remaining: <b><span id="timer">0:00</span></b>
    </div>
    <div id="webchat" role="main"></div>
    
    <script>

      (async function () {
        // In this demo, we are using Direct Line token from MockBot.
        // To talk to your bot, you should use the token exchanged using your Direct Line secret.
        // You should never put the Direct Line secret in the browser or client app.
        // https://docs.microsoft.com/en-us/azure/bot-service/rest-api/bot-framework-rest-direct-line-3-0-authentication


        // Session length in seconds
        const DEFAULT_TIME_INTERVAL = 15;

        class Timer {
            /**
            * Constructor
            * @param {seconds} integer
            * @param {onStart} function
            */
            constructor(seconds=DEFAULT_TIME_INTERVAL) {
                this.seconds = seconds;
                
                this.onStart = () => {};
                this.onSecond = () => {};
                this.onComplete = () => {};
            }

            start() {
                this.reset();
                this.onStart(this.secondsRemaining);

                this.secondInterval = setInterval(() => {
                    if (this.secondsRemaining === 0) {
                        this.stop();
                        this.onComplete();
                    } else {
                        this.secondsRemaining--;
                    }
                    this.onSecond(this.secondsRemaining);
                }, 1000);
            }

            reset() {
                this.stop();
                this.secondsRemaining = this.seconds;
            }

            stop() {
                clearInterval(this.secondInterval);
            }

            addOnStartCallback(callback) {
                this.onStart = callback;
                return this;
            }

            addOnSecondCallback(callback) {
                this.onSecond = callback;
                return this;
            }

            addOnCompleteCallback(callback) {
                this.onComplete = callback;
                return this;
            }

            static formatSeconds(seconds) {
                return `${Math.floor(seconds / 60)}:${('0' + (seconds % 60)).slice(-2)}`;
            }
        }

        function updateTimerElement(seconds) {
            const timerElement = document.getElementById("timer");
            timerElement.textContent = Timer.formatSeconds(seconds);
            timerElement.style.color = (seconds < 10 && seconds !== 0)? 'red': '#807f7f';
        }

        const timer = new Timer()
                        .addOnStartCallback(updateTimerElement)
                        .addOnSecondCallback(updateTimerElement)
                        .addOnCompleteCallback(deleteConversation);

        async function deleteConversation() {
            const { activities } = store.getState();

            // Delete Activities 
            activities.forEach( ({ id }) => {
                store.dispatch({
                    type: 'DIRECT_LINE/DELETE_ACTIVITY',
                    payload: {
                        activityID: id
                    }
                });
            });

            // Disconnect DirectLine
            store.dispatch({
                type: 'DIRECT_LINE/DISCONNECT'
            });

            // Connect to a new DirectLine conversation
            const res = await fetch('https://webchat-mockbot.azurewebsites.net/directline/token', { method: 'POST' });
            const { token } = await res.json();

            store.dispatch({
                type: 'DIRECT_LINE/CONNECT',
                payload: {
                    directLine: window.WebChat.createDirectLine({ token }),
                }
            });
        }

        const res = await fetch('https://webchat-mockbot.azurewebsites.net/directline/token', { method: 'POST' });
        const { token } = await res.json();
        
        // We are adding a new middleware to customize the behavior of WEB_CHAT/SEND_MESSAGE.
        const store = window.WebChat.createStore(
            {},
            ({ dispatch }) => next => action => {
                if (action.type === 'DIRECT_LINE/CONNECT_FULFILLED') {
                    dispatch({
                        type: 'WEB_CHAT/SEND_EVENT',
                        payload: {
                            name: 'webchat/join',
                            value: { language: window.navigator.language }
                        }
                    });
                } else if (action.type === 'WEB_CHAT/SEND_MESSAGE') {
                    timer.start();
                }
                return next(action);
            }
        );

        window.WebChat.renderWebChat({
            directLine: window.WebChat.createDirectLine({ token }),
            store
        }, document.getElementById('webchat'));

        document.querySelector('#webchat > *').focus();
      })().catch(err => console.error(err));
    </script>
  </body>
</html>
